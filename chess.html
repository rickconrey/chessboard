<!DOCTYPE HTML>
<html>
  <head>
    <title>Mutilated Chessboard</title>
    <!--<style>
      .kineticjs-content {
        margin: auto; 
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
      }
      div.kineticjs-content {
        width: 400px;
        height: 400px;
        background: #555555;
        border: 2px solid gray;
        border-radius: 5px;
        /*box-shadow: 10px 10px 5px #888888;*/
      }
    </style>-->
    <script>
      //$(document).ready(function() {
      //  $('body').on('contextmenu', 'canvas', function(e){return false;});
      //});
    </script>
  </head>
  <body>
    <div id="container" class="center"></div>
    <script src="kinetic-v4.4.3.min.js"></script>
    <script defer="defer">
      //$('body').on('contextmenu', 'canvas', function(e){return false;});

      function writeMessage(messageLayer, message) {
        var context = messageLayer.getContext();
        messageLayer.clear();
        context.font = '12pt Calibri';
        context.fillStyle = 'black';
        context.fillText(message, 370, 420);
      }
        
      function loadImages(sources, callback) {
        var images = {};
        var loadedImages = 0;
        var numImages = 0;
        for (var src in sources) {
          numImages++;
        }

        for (var src in sources) {
          images[src] = new Image();
          images[src].onload = function() {
            if(++loadedImages >= numImages) {
              callback(images);
            }
          };
          images[src].src = sources[src];
        }
      }

      function initStage(images) {
        // set the stage
        var stage = new Kinetic.Stage({
          container: 'container',
          width: 460,
          height: 460,
        });

        // define layers
        var chessLayer = new Kinetic.Layer();
        var topLayer = new Kinetic.Layer();
        var messageLayer = new Kinetic.Layer();

        // define images
        var chessboard = new Kinetic.Image({
          x: 0,
          y: 0,
          image: images.chessboard
        });
      
        var verttile = new Kinetic.Image({
          x: 410,
          y: 0,
          image: images.verttile,
          id: 0,
          //draggable: true
          dragBoundFunc: function(pos) {
            var newX, newY;
            if (pos.x < 50) {
              if (pos.y < 50 && pos.y > pos.x) {
                newX = pos.x;
                newY = 50;
              }
              else if (pos.y < 50 && pos.y < pos.x) {
                newX = 50;
                newY = pos.y;
              }
              else newX = pos.x, newY = pos.y;
            }
            else if (pos.x > 300) {
              if (pos.y > 250 && pos.y < pos.x) {
                newX = pos.x;
                newY = 250;
              }
              else if (pos.y > 250 && pos.y > pos.x) {
                newX = 300;
                newY = pos.y;
              }
              else newX = pos.x, newY = pos.y;
            }
            else newX = pos.x, newY = pos.y;
            
            return {
              x: newX,
              y: newY
            }
          }
        });

        var horiztile = new Kinetic.Image({
          x: 0,
          y: 410,
          image: images.horiztile,
          id: 1,
          //draggable: true,
          dragBoundFunc: function(pos) {
            var newX, newY;
            if (pos.x < 50) {
              if (pos.y < 50 && pos.y > pos.x) {
                newX = pos.x;
                newY = 50;
              }
              else if (pos.y < 50 && pos.y < pos.x) {
                newX = 50;
                newY = pos.y;
              }
              else newX = pos.x, newY = pos.y;
            }
            else if (pos.x > 250) {
              if (pos.y > 250 && pos.y < pos.x) {
                newX = pos.x;
                newY = 300;
              }
              else if (pos.y > 250 && pos.y > pos.x) {
                newX = 250;
                newY = pos.y;
              }
              else newX = pos.x, newY = pos.y;
            }
            else newX = pos.x, newY = pos.y;
            
            return {
              x: newX,
              y: newY
            }
          }
        });

        // add cursor styling
        verttile.on('mouseover', function() {
          document.body.style.cursor = 'pointer';
        });
        verttile.on('mouseout', function() {
          document.body.style.cursor = 'default';
        });
        horiztile.on('mouseover', function() {
          document.body.style.cursor = 'pointer';
        });
        horiztile.on('mouseout', function() {
          document.body.style.cursor = 'default';
        });

        // keep track of total horiz and vert tiles
        var total = 2;
        var allowed = 31;

        // add events
        verttile.on('click', function() {
          var id = this.getId();
          if (id === 0 && total < allowed) {
            var cloneVert = verttile.clone({x:410, y:0});
            cloneVert.setId(total++);
            cloneVert.setDraggable(true);
            //cloneVert.dragBoundFunc(function(pos) {
            //  return {x: pos.x, y:this.getAbsolutePosition().y};
            //});
            cloneVert.on('click', function(e) {
              // 1: left click, 2: middle click, 3: right click
              if (e.which == 2) {
                this.destroy();
                topLayer.draw();
                total -= 1;
                writeMessage(messageLayer, 'Total: ' + total);
              };
            });
            topLayer.add(cloneVert);
            topLayer.draw();
            writeMessage(messageLayer, 'Total: ' + total);
          }
        });

        horiztile.on('click', function() {
          var id = this.getId();
          if (id === 1 && total < allowed) {
            var cloneHoriz = horiztile.clone({x:0, y:410});
            cloneHoriz.setId(total++);
            cloneHoriz.setDraggable(true);
            cloneHoriz.on('click', function(e) {
              // 1: left click, 2: middle click, 3: right click
              if (e.which == 2) {
                this.destroy();
                topLayer.draw();
                total -= 1;
                writeMessage(messageLayer, 'Total: ' + total);
              };
            });
            topLayer.add(cloneHoriz);
            topLayer.draw();
            writeMessage(messageLayer, 'Total: ' + total);
          }
        });
        
        // add images to layers
        chessLayer.add(chessboard);
        topLayer.add(verttile);
        topLayer.add(horiztile);
    
        stage.add(chessLayer);
        stage.add(topLayer);
        stage.add(messageLayer);
      }
      var sources = {
        chessboard: 'images/chessboard.png',
        horiztile: 'images/horiztile.png',
        verttile: 'images/verttile.png'
      };
      
      loadImages(sources, initStage);
    </script>

    <!--<div class="center">
      <canvas id="chessboard" width="460" height="460"></canvas>
    </div>
    <script>
      function loadCanvas(sources, callback) {
        var images = {};
        var loadedImages = 0;
        var numImages = 0;

        // get num of sources
        for(var src in sources) {
          numImages++;
        }
        for (var src in sources) {
          images[src] = new Image();
          images[src].onload = function() {
            if(++loadedImages >= numImages) {
              callback(images);
            }
          };
          images[src].src = sources[src];
        }
      }
      var canvas = document.getElementById('chessboard');
      var context = canvas.getContext('2d');

      var sources = {
        chessboard: 'images/chessboard.png',
        verttile: 'images/verttile.png',
        horiztile: 'images/horiztile.png'
      };

      loadCanvas(sources, function(images) {
        context.drawImage(images.chessboard, 0, 0);
        context.drawImage(images.verttile, 410, 0);
        context.drawImage(images.horiztile, 0, 410);
      });

    </script>-->
  </body>
</html>
